<template>
  <div>
    <article class="mb-14 mx-auto lg:mx-0 md:max-w-4xl xl:mx-auto">
      <div class="sm-markdown">
        <h1 class="flex">
          <div
            v-if="categoryOption.order"
            class="mr-2 text-ink-lightest font-thin"
          >
            {{ article.order }}.
          </div>
          <span v-html="formattedTitle"></span>
        </h1>
      </div>

      <p
        v-if="article.description"
        class="mt-5 text-gray-dark max-w-prose leading-tight md:leading-snug text-base md:text-lg lg:text-xl"
      >
        {{ article.description }}
      </p>

      <article-share-list
        class="mt-6"
        :color="categoryOption.color"
        :path="article.path"
        :title="article.title"
        :description="article.description"
      />

      <!-- Top Image -->
      <div v-if="article.imageTop || categoryOption.imageTop">
        <div class="mt-6 bg-gray-lightest shadow-md">
          <div
            class="mx-auto flex justify-center"
            :class="categoryOption.image"
          >
            <app-image
              :dir="categoryOption.dir"
              :img="article.slug"
              :width="categoryOption.width"
              :height="categoryOption.height"
            />
          </div>
        </div>
        <hr class="border-gray-lighter mt-8" />
      </div>

      <article-avatar class="mt-10" :updated-at="article.updatedAt" />

      <nuxt-content class="sm-markdown mt-10" :document="article" />

      <!-- Bottom Image -->
      <div
        v-if="article.imageBottom || categoryOption.imageBottom"
        class="mx-auto md:mx-0 max-w-md mt-14 shadow-md"
      >
        <app-image
          :dir="categoryOption.dir"
          :img="article.slug"
          :width="categoryOption.width"
          :height="categoryOption.height"
          display-class="block"
        />
      </div>
    </article>

    <slot name="center"></slot>

    <!-- TODO: add prev -->
    <article-pagination
      v-if="next"
      :path="next.path"
      :color="categoryOption.paginationColor"
      :label="categoryOption.paginationLabel"
      :text="paginationText"
    />

    <article-share
      class="mt-12"
      :color="categoryOption.color"
      :path="article.path"
      :title="article.title"
      :description="article.description"
    />
    <article-community-edit :path="article.path" />

    <article-related
      class="mt-14"
      :text="categoryOption.relatedText"
      :color="categoryOption.relatedColor"
      :border="categoryOption.relatedBorder"
      :related="related"
    />
  </div>
</template>

<script>
import sanitizeHtml from 'sanitize-html';

function formatTitle(str) {
  const regex = /`(.*)`/;
  return str.replace(regex, '<code>$1</code>');
}

const SQUARE_IMAGE = {
  width: 448,
  height: 448,
  image: 'max-w-xs md:max-w-sm xl:max-w-md',
};

const COURSE_OPTION = {
  color: 'blue',
  relatedText: 'Free Courses',
  relatedColor: 'orchid',
  relatedBorder: true,
  paginationColor: 'indigo',
  ...SQUARE_IMAGE,
};

const CATEGORY_OPTION = {
  tidbits: {
    dir: 'tidbits',
    imageTop: true,
    imageBottom: true,
    order: false,
    color: 'orange',
    relatedText: 'Related Tidbits',
    relatedColor: 'orange',
    relatedBorder: true,
    paginationLabel: 'Next Tidbit',
    ...SQUARE_IMAGE,
  },
  blog: {
    dir: 'blog',
    imageTop: true,
    imageBottom: false,
    order: false,
    color: 'green',
    image: 'max-w-lg lg:max-w-xl xl:max-w-2xl 2xl:max-w-3xl',
    width: 768,
    height: 432,
    relatedText: 'Related Articles',
    relatedColor: 'green',
    relatedBorder: true,
    paginationLabel: 'Next Article',
  },
  flexbox30: {
    dir: 'flexbox30',
    imageTop: false,
    imageBottom: true,
    order: true,
    ...COURSE_OPTION,
  },
  basics: {
    dir: 'basics',
    imageTop: true,
    imageBottom: true,
    order: false,
    ...COURSE_OPTION,
  },
  pictorials: {
    dir: 'pictorials',
    imageTop: true,
    imageBottom: false,
    order: false,
    ...COURSE_OPTION,
  },
};

export default {
  props: {
    article: {
      type: Object,
      required: true,
    },
    next: {
      type: Object,
      default: undefined,
    },
    category: {
      type: String,
      required: true,
      validator: (value) => Object.keys(CATEGORY_OPTION).includes(value),
    },
    related: {
      type: Array,
      required: true,
    },
    paginationLabel: {
      type: String,
      default: undefined,
    },
  },
  computed: {
    categoryOption() {
      return CATEGORY_OPTION[this.category];
    },
    formattedTitle() {
      const html = formatTitle(this.article.title);

      return sanitizeHtml(html);
    },
    paginationText() {
      if (this.categoryOption.order) {
        return `${this.next.order}. ${this.next.title}`;
      }

      return this.next.title;
    },
  },
};
</script>
